---
globs: docker-compose*.yaml,docker-compose*.yml
---

# Docker Compose Rules

## Core Principles
- Compose files should be simple, readable, and environment-agnostic.
- Prioritize security, reproducibility, and maintainability.
- Keep production, development, and testing configs separated or layered.

## Services
- Define one service per responsibility (app, db, cache, etc.).
- Use official/trusted images pinned to versions or digests (avoid "latest").
- Avoid embedding secrets or credentials directly in compose files.

## Security Options
- Do not run services as root unless strictly necessary.
- Prefer non-root users via the `user` directive when supported by the image.
- Avoid `privileged: true`; only use it as a last resort with a clear justification.
- Use `read_only: true` for services that do not need to write to the filesystem.
- Drop capabilities by default:
  - `cap_drop: ["ALL"]`
  - Add only the minimal required capabilities with `cap_add`.
- Use `security_opt: ["no-new-privileges:true"]` where applicable.
- Avoid mapping sensitive host paths, devices, or sockets into containers unless strictly required.

## Volumes and Mounts
- Mount only necessary paths; avoid mounting sensitive host directories.
- Use named volumes for persistent data; keep ephemeral data in tmpfs.
- Be explicit with read-only mounts (`:ro`) when possible.

## Networks
- Use custom networks instead of the default network.
- Assign clear service names as hostnames for inter-service communication.
- Restrict service exposure with `expose` vs `ports`:
  - use `expose` for internal-only communication,
  - map `ports` only when external access is required.

## Environment and Config
- Store secrets in `.env` files or external secret managers, never inline in the compose file.
- Use environment variables for configuration defaults, not credentials.
- Document expected variables in a `.env.draft` or similar template file.

## Resource Management
- Define resource limits (`cpus`, `mem_limit`) to avoid host overload.
- Use healthchecks to ensure service readiness.
- Set restart policies (`always`, `unless-stopped`, `on-failure`) appropriately.

## Development vs Production
- Use `docker-compose.dev.yml` for local development customizations. (dev containers)
- Keep production (docker-compose.yml) files minimal and secure (no debug mounts, logs in volumes).
- Separate build contexts for dev and production when needed.

## Anti-Patterns
- Using `latest` image tags.
- Embedding credentials or secrets inline.
- Mapping privileged host devices unnecessarily.
- Relying on default network and service naming.
- Excessive volume mounts to the host filesystem.